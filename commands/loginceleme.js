const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, StringSelectMenuBuilder, StringSelectMenuOptionBuilder, ComponentType } = require('discord.js');const fs = require('fs').promises;const path = require('path');module.exports = {  name: 'loginceleme',  description: 'Log kayÄ±tlarÄ±nÄ± detaylÄ± bir ÅŸekilde incelemenizi saÄŸlar',  async execute(message, args, client) {    const logTypes = [      { id: 'mesaj', name: 'ğŸ“ Mesaj LoglarÄ±', description: 'Mesaj gÃ¶nderme, silme, dÃ¼zenleme iÅŸlemleri', emoji: 'ğŸ“', color: '#5865F2' },      { id: 'uye', name: 'ğŸ‘¤ Ãœye LoglarÄ±', description: 'Sunucuya giriÅŸ, Ã§Ä±kÄ±ÅŸ, yasaklama iÅŸlemleri', emoji: 'ğŸ‘¤', color: '#FF5555' },      { id: 'ses', name: 'ğŸ”Š Ses LoglarÄ±', description: 'Ses kanalÄ± giriÅŸ/Ã§Ä±kÄ±ÅŸ ve durum deÄŸiÅŸiklikleri', emoji: 'ğŸ”Š', color: '#43B581' },      { id: 'kanal', name: 'ğŸ“‚ Kanal LoglarÄ±', description: 'Kanal oluÅŸturma, silme, gÃ¼ncelleme iÅŸlemleri', emoji: 'ğŸ“‚', color: '#FAA61A' },      { id: 'rol', name: 'ğŸ‘‘ Rol LoglarÄ±', description: 'Rol oluÅŸturma, silme, gÃ¼ncelleme iÅŸlemleri', emoji: 'ğŸ‘‘', color: '#EB459E' }    ];    const logDir = path.join(__dirname, '..', 'logs');    const selectMenu = new StringSelectMenuBuilder()      .setCustomId('log_type')      .setPlaceholder('Ä°ncelemek istediÄŸiniz log tÃ¼rÃ¼nÃ¼ seÃ§in')      .addOptions(        logTypes.map(type =>           new StringSelectMenuOptionBuilder()            .setLabel(type.name)            .setDescription(type.description)            .setValue(type.id)            .setEmoji(type.emoji)        )      );    const row = new ActionRowBuilder().addComponents(selectMenu);    const mainEmbed = new EmbedBuilder()      .setTitle('ğŸ“Š Log Ä°nceleme Sistemi')      .setDescription('Discord sunucunuzdaki log kayÄ±tlarÄ±nÄ± detaylÄ± bir ÅŸekilde inceleyebilirsiniz. AÅŸaÄŸÄ±daki menÃ¼den incelemek istediÄŸiniz log tÃ¼rÃ¼nÃ¼ seÃ§in.')      .setColor('#5865F2')      .addFields({        name: 'ğŸ“‹ Mevcut Log TÃ¼rleri',        value: logTypes.map(type => `${type.emoji} **${type.name}** - ${type.description}`).join('\n'),        inline: false      })      .setFooter({ text: 'Discord Logger - DetaylÄ± Log Ä°nceleme Sistemi' })      .setTimestamp();    try {      const response = await message.reply({        embeds: [mainEmbed],        components: [row]      });      const logCache = {};      const collector = response.createMessageComponentCollector({         componentType: ComponentType.StringSelect,        time: 300000       });      collector.on('collect', async (interaction) => {        if (interaction.user.id !== message.author.id) {          return interaction.reply({             content: 'âŒ Bu menÃ¼yÃ¼ sadece komutu Ã§alÄ±ÅŸtÄ±ran kiÅŸi kullanabilir!',             ephemeral: true           });        }        collector.resetTimer();        const selectedLogType = interaction.values[0];        const logTypeInfo = logTypes.find(type => type.id === selectedLogType);        if (!logTypeInfo) {          return interaction.reply({             content: 'âŒ GeÃ§ersiz log tÃ¼rÃ¼!',             ephemeral: true           });        }        let logData;        if (logCache[selectedLogType]) {          logData = logCache[selectedLogType];        } else {          try {            const logFilePath = path.join(logDir, `${selectedLogType}.log`);            let rawData;            try {              rawData = await fs.readFile(logFilePath, 'utf8');            } catch (error) {              if (error.code === 'ENOENT') {                rawData = '[]';              } else {                throw error;              }            }            logData = JSON.parse(rawData);            logCache[selectedLogType] = logData;          } catch (error) {            console.error(`Log dosyasÄ± okuma hatasÄ±: ${error}`);            return interaction.reply({              content: `âŒ Log verilerini okurken bir hata oluÅŸtu: ${error.message}`,              ephemeral: true            });          }        }        logData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));        const itemsPerPage = 5;        const totalPages = Math.ceil(logData.length / itemsPerPage) || 1;        let currentPage = 0;        const createLogContent = (page) => {          const startIdx = page * itemsPerPage;          const endIdx = Math.min(startIdx + itemsPerPage, logData.length);          const pageItems = logData.slice(startIdx, endIdx);          if (pageItems.length === 0) {            return '```\nBu log tÃ¼rÃ¼ iÃ§in kayÄ±t bulunamadÄ±.\n```';          }          return pageItems.map((log, idx) => {            const date = new Date(log.timestamp).toLocaleString('tr-TR');            const title = `${idx + 1 + startIdx}. [${date}] ${log.title || 'Ä°simsiz Log'}`;            let content = '';            if (selectedLogType === 'mesaj') {              content = `KullanÄ±cÄ±: ${log.user?.tag || 'Bilinmiyor'}\nKanal: ${log.channel?.name || 'Bilinmiyor'}\nÄ°Ã§erik: ${log.content || 'Ä°Ã§erik yok'}\nÄ°ÅŸlem: ${log.action || 'Bilinmiyor'}`;            } else if (selectedLogType === 'uye') {              content = `KullanÄ±cÄ±: ${log.user?.tag || 'Bilinmiyor'}\nID: ${log.userId || 'Bilinmiyor'}\nÄ°ÅŸlem: ${log.action || 'Bilinmiyor'}\nYetkili: ${log.moderator?.tag || 'Sistem'}`;            } else if (selectedLogType === 'ses') {              content = `KullanÄ±cÄ±: ${log.user?.tag || 'Bilinmiyor'}\nKanal: ${log.channel?.name || 'Bilinmiyor'}\nDurum: ${log.state || 'Bilinmiyor'}\nDeÄŸiÅŸiklik: ${log.change || 'Bilinmiyor'}`;            } else if (selectedLogType === 'kanal') {              content = `Kanal: ${log.channel?.name || 'Bilinmiyor'}\nTÃ¼r: ${log.channelType || 'Bilinmiyor'}\nÄ°ÅŸlem: ${log.action || 'Bilinmiyor'}\nYetkili: ${log.moderator?.tag || 'Sistem'}`;            } else if (selectedLogType === 'rol') {              content = `Rol: ${log.role?.name || 'Bilinmiyor'}\nÄ°ÅŸlem: ${log.action || 'Bilinmiyor'}\nHedef: ${log.target?.tag || 'Bilinmiyor'}\nYetkili: ${log.moderator?.tag || 'Sistem'}`;            } else {              content = JSON.stringify(log, null, 2);            }            return `**${title}**\n\`\`\`\n${content}\n\`\`\`\n`;          }).join('\n');        };        const createLogEmbed = (page) => {          return new EmbedBuilder()            .setTitle(`${logTypeInfo.emoji} ${logTypeInfo.name} - DetaylÄ± Ä°nceleme`)            .setDescription(createLogContent(page))            .setColor(logTypeInfo.color)            .setFooter({ text: `Sayfa ${page + 1}/${totalPages} â€¢ Toplam ${logData.length} kayÄ±t â€¢ Discord Logger` })            .setTimestamp();        };        const createNavButtons = () => {          const navRow = new ActionRowBuilder()            .addComponents(              new ButtonBuilder()                .setCustomId('first_page')                .setLabel('â®ï¸ Ä°lk')                .setStyle(ButtonStyle.Primary)                .setDisabled(currentPage === 0),              new ButtonBuilder()                .setCustomId('prev_page')                .setLabel('â—€ï¸ Ã–nceki')                .setStyle(ButtonStyle.Secondary)                .setDisabled(currentPage === 0),              new ButtonBuilder()                .setCustomId('next_page')                .setLabel('Sonraki â–¶ï¸')                .setStyle(ButtonStyle.Secondary)                .setDisabled(currentPage === totalPages - 1),              new ButtonBuilder()                .setCustomId('last_page')                .setLabel('Son â­ï¸')                .setStyle(ButtonStyle.Primary)                .setDisabled(currentPage === totalPages - 1),              new ButtonBuilder()                .setCustomId('back_to_menu')                .setLabel('ğŸ” MenÃ¼ye DÃ¶n')                .setStyle(ButtonStyle.Danger)            );          const filterRow = new ActionRowBuilder()            .addComponents(              new StringSelectMenuBuilder()                .setCustomId('filter_by')                .setPlaceholder('Filtreleme seÃ§enekleri')                .addOptions([                  new StringSelectMenuOptionBuilder()                    .setLabel('TÃ¼m KayÄ±tlar')                    .setDescription('TÃ¼m log kayÄ±tlarÄ±nÄ± gÃ¶ster')                    .setValue('all')                    .setEmoji('ğŸ“‹'),                  new StringSelectMenuOptionBuilder()                    .setLabel('BugÃ¼nkÃ¼ KayÄ±tlar')                    .setDescription('Sadece bugÃ¼ne ait kayÄ±tlarÄ± gÃ¶ster')                    .setValue('today')                    .setEmoji('ğŸ“…'),                  new StringSelectMenuOptionBuilder()                    .setLabel('Son 24 Saat')                    .setDescription('Son 24 saate ait kayÄ±tlarÄ± gÃ¶ster')                    .setValue('last24')                    .setEmoji('â±ï¸'),                  new StringSelectMenuOptionBuilder()                    .setLabel('Ekleme Ä°ÅŸlemleri')                    .setDescription('Sadece ekleme/oluÅŸturma iÅŸlemlerini gÃ¶ster')                    .setValue('add')                    .setEmoji('â•'),                  new StringSelectMenuOptionBuilder()                    .setLabel('Silme Ä°ÅŸlemleri')                    .setDescription('Sadece silme iÅŸlemlerini gÃ¶ster')                    .setValue('delete')                    .setEmoji('ğŸ—‘ï¸'),                  new StringSelectMenuOptionBuilder()                    .setLabel('DÃ¼zenleme Ä°ÅŸlemleri')                    .setDescription('Sadece dÃ¼zenleme iÅŸlemlerini gÃ¶ster')                    .setValue('edit')                    .setEmoji('âœï¸')                ])            );          return [navRow, filterRow];        };        await interaction.update({          embeds: [createLogEmbed(currentPage)],          components: createNavButtons()        });        const buttonCollector = response.createMessageComponentCollector({           componentType: ComponentType.Button,          time: 300000         });        buttonCollector.on('collect', async (btnInteraction) => {          if (btnInteraction.user.id !== message.author.id) {            return btnInteraction.reply({               content: 'âŒ Bu menÃ¼yÃ¼ sadece komutu Ã§alÄ±ÅŸtÄ±ran kiÅŸi kullanabilir!',               ephemeral: true             });          }          buttonCollector.resetTimer();          if (btnInteraction.customId === 'first_page') {            currentPage = 0;          } else if (btnInteraction.customId === 'prev_page') {            currentPage = Math.max(0, currentPage - 1);          } else if (btnInteraction.customId === 'next_page') {            currentPage = Math.min(totalPages - 1, currentPage + 1);          } else if (btnInteraction.customId === 'last_page') {            currentPage = totalPages - 1;          } else if (btnInteraction.customId === 'back_to_menu') {            await btnInteraction.update({              embeds: [mainEmbed],              components: [row]            });            buttonCollector.stop();            return;          }          await btnInteraction.update({            embeds: [createLogEmbed(currentPage)],            components: createNavButtons()          });        });        const filterCollector = response.createMessageComponentCollector({           componentType: ComponentType.StringSelect,          time: 300000         });        filterCollector.on('collect', async (selectInteraction) => {          if (selectInteraction.user.id !== message.author.id) {            return selectInteraction.reply({               content: 'âŒ Bu menÃ¼yÃ¼ sadece komutu Ã§alÄ±ÅŸtÄ±ran kiÅŸi kullanabilir!',               ephemeral: true             });          }          filterCollector.resetTimer();          if (selectInteraction.customId === 'log_type') {            buttonCollector.stop();            return;          }          if (selectInteraction.customId === 'filter_by') {            const filterType = selectInteraction.values[0];            let filteredData = [...logCache[selectedLogType]];            const now = new Date();            if (filterType === 'today') {              filteredData = filteredData.filter(log => {                const logDate = new Date(log.timestamp);                return logDate.getDate() === now.getDate() &&                       logDate.getMonth() === now.getMonth() &&                       logDate.getFullYear() === now.getFullYear();              });            } else if (filterType === 'last24') {              const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);              filteredData = filteredData.filter(log => new Date(log.timestamp) >= oneDayAgo);            } else if (filterType === 'add') {              filteredData = filteredData.filter(log =>                 log.action?.toLowerCase().includes('ekle') ||                 log.action?.toLowerCase().includes('oluÅŸtur') ||                 log.action?.toLowerCase().includes('create') ||                 log.action?.toLowerCase().includes('add')              );            } else if (filterType === 'delete') {              filteredData = filteredData.filter(log =>                 log.action?.toLowerCase().includes('sil') ||                 log.action?.toLowerCase().includes('delete') ||                 log.action?.toLowerCase().includes('remove')              );            } else if (filterType === 'edit') {              filteredData = filteredData.filter(log =>                 log.action?.toLowerCase().includes('dÃ¼zenle') ||                 log.action?.toLowerCase().includes('gÃ¼ncelle') ||                 log.action?.toLowerCase().includes('edit') ||                 log.action?.toLowerCase().includes('update')              );            }            logData = filteredData;            currentPage = 0;            const totalFilteredPages = Math.ceil(logData.length / itemsPerPage) || 1;            const filteredEmbed = new EmbedBuilder()              .setTitle(`${logTypeInfo.emoji} ${logTypeInfo.name} - ${selectInteraction.component.options.find(o => o.value === filterType).label}`)              .setDescription(logData.length > 0 ? createLogContent(currentPage) : '```\nBu filtre iÃ§in kayÄ±t bulunamadÄ±.\n```')              .setColor(logTypeInfo.color)              .setFooter({ text: `Sayfa ${currentPage + 1}/${totalFilteredPages} â€¢ Toplam ${logData.length} kayÄ±t â€¢ Filtre: ${selectInteraction.component.options.find(o => o.value === filterType).label}` })              .setTimestamp();            await selectInteraction.update({              embeds: [filteredEmbed],              components: createNavButtons()            });          }        });      });      collector.on('end', async () => {        const disabledRow = new ActionRowBuilder()          .addComponents(            selectMenu.setDisabled(true)          );        await response.edit({          components: [disabledRow]        }).catch(() => {});      });    } catch (error) {      console.error('Log inceleme hatasÄ±:', error);      return message.reply('âŒ Log inceleme sistemi baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu!');    }  }}; 